###################################################################################
# real data
###################################################################################

library(readxl)

# April data loading
cust_mon_04 <- read_excel("data/cust_mon_201804.xlsx")
head(cust_mon_04)
dim(cust_mon_04) # 146,514건의 거래내용 확인
colnames(cust_mon_04) <- c('date', 'custid', 'grade', 'prod_code', 'qty', 'amt')
head(cust_mon_04)

# cust_mon_04$grade 컬럼의 내용을 영문으로 변경
unique(cust_mon_04$grade)

cust_mon_04$grade[cust_mon_04$grade == '바디러브'] <- 'bodylove'
cust_mon_04$grade[cust_mon_04$grade == '클럽'] <- 'club'
cust_mon_04$grade[cust_mon_04$grade == '골드'] <- 'gold'
cust_mon_04$grade[cust_mon_04$grade == '웹멤버'] <- 'webmember'

unique(cust_mon_04$grade)
head(cust_mon_04)

# May data loading
cust_mon_05 <- read_excel("data/cust_mon_201805.xlsx")
head(cust_mon_05)
dim(cust_mon_05) # 217,717건의 거래내용 확인
colnames(cust_mon_05) <- c('date', 'custid', 'grade', 'prod_code', 'qty', 'amt')
head(cust_mon_05)

# cust_mon_05$grade 컬럼의 내용을 영문으로 변경
unique(cust_mon_05$grade)

cust_mon_05$grade[cust_mon_05$grade == '바디러브'] <- 'bodylove'
cust_mon_05$grade[cust_mon_05$grade == '클럽'] <- 'club'
cust_mon_05$grade[cust_mon_05$grade == '골드'] <- 'gold'
cust_mon_05$grade[cust_mon_05$grade == '웹멤버'] <- 'webmember'

unique(cust_mon_05$grade)
head(cust_mon_05)

# rbinding data
cust_mon_total <- rbind(cust_mon_04, cust_mon_05)
head(cust_mon_total)
dim(cust_mon_04)[1] + dim(cust_mon_05)[1] == dim(cust_mon_total)[1] # True 확인
str(cust_mon_total)

cust_mon_total$date <- as.character(cust_mon_total$date)
cust_mon_total$year <- substr(cust_mon_total$date, 1, 4)
cust_mon_total$mon <- substr(cust_mon_total$date, 5, 6)
cust_mon_total$day <- substr(cust_mon_total$date, 7, 8)
head(cust_mon_total)

cust_mon_total$ymd <- paste(cust_mon_total$year, cust_mon_total$mon, cust_mon_total$day, sep='-')
head(cust_mon_total)
cust_mon_total$ymd <- as.Date(cust_mon_total$ymd, format='%Y-%m-%d')
head(cust_mon_total)

# select columns needed
cust_mon_total %>% select(ymd, custid, prod_code, amt) -> sale
dim(sale) # 4~5월 364,231건의 물품별 거래건수 확인
length(unique(sale$custid)) # 4~5월 고객의 수 :: 118,058명
head(sale)

## Frequency dimension

sale %>% 
  mutate(ymd_custid = paste(ymd, custid)) %>%
  distinct(ymd_custid) -> df_F
head(df_F)
nrow(df_F) # 4~5월 139,843건의 장바구니 거래건수 확인

df_F %>%
  mutate(ymd=substr(ymd_custid, 1, 10), 
         custid=substr(ymd_custid, 12, length(ymd_custid))) -> df_F


# df_F에서 고객별로 묶어 행의 갯수를 세어 해당 고객의 총 방문회수를 구하여 userF에 저장
df_F %>%
  group_by(custid) %>%
  summarise(frequency = n()) -> userF
head(userF)
str(userF)
range(userF$frequency)
boxplot(userF$frequency, horizontal = T)

str(sale)
max(sale$ymd)
min(sale$ymd)
range(sale$amt)

sale %>% 
  group_by(custid) %>%
  summarise(minRecency=min(ymd),
            recency=max(ymd),
            monetary=sum(amt),
            period=as.numeric(max(ymd)-min(ymd))) -> userRFM
head(userRFM)
nrow(userRFM) # 4~5월 고객의 수 :: 118,058명

left_join(userRFM, userF, by='custid') -> userRFM
head(userRFM)

########################### recency(최근방문일자)에 대한 EDA ###########################
# 고객들의 최근 방문일자에 대한 히스토그램
hist(userRFM$recency, breaks=61, main='Guest Recency')
table(userRFM$recency)
plot(table(userRFM$recency), main='Guest Recency')

# 5월 13일이 최근 방문일자가 되는 고객의 수가 가장 많음 -> 5.13은 일요일인데 이때 이벤트 기간??
# 보통 일반적으로 최근일자에 대한 고객 그래프는 주어진 데이터의 경우 일정한 분포를 보이는 경향
# 고객들이 매장을 반복적으로 찾는 경우가 드물기 때문인 것으로 추정됨.

########################### monetary(구매액)에 대한 EDA ###########################
# 고객별 총 지출금액에 대한 시각화
range(userRFM$monetary)
windows()
hist(userRFM$monetary, breaks=10000, main='Guest Monetary')

# 0~10만원 사이 구매거래 회수 중 10000원(만원) 단위로 쪼개보기
hist(userRFM$monetary, breaks=2000, main='Guest Monetary', xlim=c(0,100000))

# 0~10만원 사이 구매거래 회수 중 1000원(천원) 단위로 쪼개보기
hist(userRFM$monetary, breaks=20000, main='Guest Monetary', xlim=c(0,100000))

# 0~10만원 사이 구매거래 회수 중 100원(백원) 단위로 쪼개보기
hist(userRFM$monetary, breaks=200000, main='Guest Monetary', xlim=c(0,100000))

# 2만원~2만1천원 사이에서 구매하는 고객들의 수가 가장 많음


########################### frequenct(구매액)에 대한 EDA ###########################
# 고객별 매장방문 회수에 대한 시각화
head(userRFM)
range(userRFM$frequency) # 39번까지 방문한 고객이 있네요...뉴규??
userRFM %>%
  filter(frequency==39)
# A tibble: 1 x 6
# custid           minRecency recency    monetary period frequency
# <chr>            <date>     <date>        <dbl>  <dbl>     <int>
# 2005658405552920 2018-04-01 2018-05-30 4985490.    59.        39

# id가 2005658405552920인 고객은 4~5월간 약 50만원을 소비하고 매장을 39번 방문한 초로얄 고객임.
# 무슨 혜택은 드렸는지 궁금??

hist(userRFM$frequency, breaks = 50)
hist(userRFM$frequency, breaks = 50, xlim=c(1, 10))
hist(userRFM$frequency, breaks = 50, xlim=c(1, 5))

userRFM %>%
  filter(frequency > 1) -> freq_2_more
dim(freq_2_more) # 2번 이상 방문한 고객은 16,198명 :: 전체의 13.7%

(16198 / 118058) * 100

userRFM %>%
  filter(frequency > 2) -> freq_3_more
dim(freq_3_more) # 3번 이상 방문한 고객은 3,080명 :: 전체의 2.6%

(3080 / 118058) * 100

userRFM %>%
  filter(frequency > 3) -> freq_4_more
dim(freq_4_more) # 4번 이상 방문한 고객은 1,043명 :: 전체의 0.9%

(1043 / 118058) * 100


# 4~5월간 대부분의 고객들은 매장을 한 번 방문하였고 2번 이상은 13.7%, 3번 이상은 2.6%, 4번 이상은 .9%
# 의 비율을 차지함 / 자주 매장에 오는 고객이 매우 드문것이 문제인 듯..
