
```{r }
setwd("C:/Users/Daniel/rfm")
getwd()

rm(list=ls()); gc()

library(plyr)
library(tidyverse)
library(data.table)
library(lubridate)

tracing_cust_grade <- read_csv("data/tracing_cust_grade.csv")
colnames(tracing_cust_grade) <- c('X1', 'custid', '2016-06', '2016-09', '2016-12', '2017-03', 
                                  '2017-06', '2017-09', '2017-12', '2018-03', '2018-06')

tracing_cust_grade %>%
  select(-X1) -> tracing_cust_grade; head(tracing_cust_grade)

dim(tracing_cust_grade)

as.factor(tracing_cust_grade$custid) -> tracing_cust_grade$custid; head(tracing_cust_grade)
head(tracing_cust_grade)

tracing_cust_grade %>%
  replace(.=="A", 5) %>%
  replace(.=="B", 4) %>%
  replace(.=="C", 3) %>%
  replace(.=="D", 2) %>%
  replace(.=="E", 1) %>%
  replace(is.na(.), 0) -> tracing

head(tracing)

n <- nrow(tracing)
idx <- 1:n
sample_idx <- sample(idx, n * .001)
sample_n <- length(sample_idx)
sample_n # 1344

tracing_sample <- tracing[sample_idx,]
nrow(tracing_sample)
head(tracing_sample)

tracing_sample[, 1]$custid -> sample_custid; 
sample_custid[1:10]

tracing_sample[, -1] %>% head

tracing_sample_T <- t(tracing_sample[, -1])
dim(tracing_sample_T)

tracing_T <- as.data.frame(tracing_sample_T)[1:9, 1:sample_n]
colnames(tracing_T) <- sample_custid


plot_sample_df <- tracing_T[1:9, 1:1000]; 
plot_sample_df


# 5명에 대한 점수변화 시각화

df <- plot_sample_df[, 1:5]
df <- cbind(months = rownames(df), df)
rownames(df) <- NULL
df$months <- as.character(df$months)
str(df$months)
dim(df)

library(reshape2)
dfm = melt(df, id.vars='months'); dfm

ggplot(dfm, aes(x=months, y=value, colour=variable)) + 
  geom_line(aes(color = variable, group = variable, linetype = variable), size=1) 

# 100명에 대한 점수변화 시각화
df <- plot_sample_df[, 1:100]
df <- cbind(months = rownames(df), df)
rownames(df) <- NULL
df$months <- as.character(df$months)
str(df$months)
dim(df)

library(reshape2)
dfm = melt(df, id.vars='months'); dfm

ggplot(dfm, aes(x=months, y=value, group=variable)) +
  theme_bw() +
  theme(panel.grid=element_blank()) +
  geom_line(size=0.2, alpha=0.1)


# 특정 고객 한 명을 지정하여 등급변화 시각화하기

head(tracing)
as.character(tracing$custid) -> tracing$custid

tracing %>%
  filter(custid == 'C00000030') -> df_a_cust; df_a_cust

df_a_cust[, 1]$custid -> a_custid; a_custid

df_a_cust_T <- t(df_a_cust[, -1]); df_a_cust_
tracing_T <- as.data.frame(df_a_cust_T); tracing_T
colnames(tracing_T) <- a_custid ; tracing_T
df <- tracing_T
df <- data.frame(months = rownames(df), C00000030 = df$C00000030); df
rownames(df) <- NULL
df

library(reshape2)
dfm = melt(df, id.vars='months'); dfm

ggplot(dfm, aes(x=months, y=as.numeric(value), colour=variable)) + 
  geom_line(aes(color = variable, group = variable, linetype = variable), size=1) + 
  ylim(0, 5) +
  ylab('grades')


# 고객의 등급이 올라간 횟수
# 고객의 등급이 내려간 횟수
# 고객의 등급의 평균
# 고객 등급의 변동계수(표준편차 / 평균)
# 고객의 시작 등급
# 고객의 마지막 등급
# 연속적인 E 등급의 갯수


# 고객의 등급이 올라간 횟수
head(tracing)
ncol(tracing) - 1


## "C00158793" 고객의 등급이 올라간 회수 구해보기
tracing[158793, ]
tracing[158793, -1] -> df_158793; df_158793

diff <- c()
for (i in 2:(ncol(tracing)-1)) {
  # print(i)
  j <- (as.numeric(df_158793[, c(i-1, i)][, 2]) - as.numeric(df_158793[, c(i-1, i)][, 1]))
  print(j)
  diff <- append(diff, j)
}

length(diff[diff > 0]) # 0번
```


---
title: "cust_clustering.R"
author: "Daniel"
date: "Tue Nov 13 09:06:08 2018"
---
